import os
from git.models import Repository
from solution.models import Solution

# Configurations for the gitolite admin repo

prefix = """
#===========================
# Administration
#===========================

repo\tgitolite-admin
\tRW\t=\temil

#===========================
# Repositories
#===========================

"""


def update_permissions():
    """
    Update gitolite permissions
    """
    # Find file paths
    gitolite_admin_directory = os.path.dirname(os.path.realpath(__file__))+"/gitolite-admin/"
    gitolite_conf_file_path = gitolite_admin_directory+"conf/gitolite.conf"
    with open(gitolite_conf_file_path, 'w') as f:
        f.write("#***************************\n")
        f.write("# Generated by Joltem\n")
        f.write("#***************************\n")
        f.write(prefix)
        repos = Repository.objects.all()
        for repo in repos:
            # Repository permissions
            f.write("repo\t%s\n" % repo.full_name)
            f.write("\tR\t=\t@all\n")
            f.write("\tRW\t=\t%s\n" % "\t".join(user.username for user in repo.project.users.all()) )
            # Personal branches
            # http://gitolite.com/gitolite/special.html
            f.write("\tRW\tu/USER/\t=\t@all\n")
            # Solution branch permission
            for task in repo.project.task_set.all():
                for solution in task.solution_set.all():
                    f.write("\tRW\ts/%d$\t=\t%s\n" % (solution.id, solution.user.username))

    print "\n*** Wrote configuration file to %s, is closed : %s.\n" % (gitolite_conf_file_path, f.closed)
    # Commit and push changes
    from subprocess import call
    print "\n*** Commit permission changes\n."
    call("git --git-dir=%s.git --work-tree=%s commit -v -am 'Permission changes.'" % (gitolite_admin_directory, gitolite_admin_directory), shell=True)
    print "\n*** Push permission changes.\n"
    call("git --git-dir=%s.git --work-tree=%s push -v" % (gitolite_admin_directory, gitolite_admin_directory), shell=True)
