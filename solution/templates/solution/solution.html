{% extends 'solution/base.html' %}
{% load markup %}
{% load filters %}
{% block solution_content %}
    <div class="row hidden-desktop hidden-tablet">
        <div class="span8">
            <img class="img-rounded pull-right" src="https://secure.gravatar.com/avatar/{{ solution.user.get_profile.gravatar_hash }}?s=50" /></p>
            <h4><a href="{% url 'user' solution.user.username %}">{{ solution.user.first_name }}</a></h4>
            <p><b>{{ solution.user.get_profile.impact }}</b> impact <b>{{ solution.user.get_profile.completed }}</b> solutions</p>
            <hr class="clearfix"/>
        </div>
    </div>
    <div class="row">
        <div class="span2 hidden-phone">
            <h4><a href="{% url 'user' solution.user.username %}">{{ solution.user.first_name }}</a></h4>
            <p><img class="img-rounded" src="https://secure.gravatar.com/avatar/{{ solution.user.get_profile.gravatar_hash }}?s=100" /></p>
            <p><b>{{ solution.user.get_profile.impact }}</b> impact</p>
            <p><b>{{ solution.user.get_profile.completed }}</b> solutions</p>
        </div>
        <div class="span8">
            {% if solution.title %}
                <h4>{{ solution.title }}</h4>
            {% else %}
                <h4>{{ solution.task.title }} <span class="muted">by {{ solution.user.first_name }}</span></h4>
            {% endif %}
            {% if solution.description %}
                {{ solution.description|markdown:"tables,fenced_code" }}
            {% else %}
                <p class="muted">Solution has not been described yet.</p>
            {% endif %}
            <form method="post">
                {% csrf_token %}
                <div class="btn-group">
                    {% if is_owner %}
                        {% if not solution.is_completed %}
                            <button class="btn btn-info" type="submit" name="complete" value="1"><i class="icon-ok icon-white"></i></button>
                        {% endif %}
                        <a href="{% url 'project:solution:solution_edit' project.name solution.id %}" class="btn">edit</a>
                        {% if not solution.is_completed %}
                            <button class="btn" type="submit" name="delete" value="1"></i>delete</button>
                        {% endif %}
                        {% if solution.is_accepted %}
                            <a class="btn btn-success" href="{% url 'project:task:new' project.name solution.id %}">create subtask</a>
                        {% endif %}
                    {% else %}
                        {% if not solution.is_completed %}
                            <a class="btn btn-success" href="{% url 'project:solution:new' project.name solution.id%}">suggest solution</a>
                        {% endif %}
                    {% endif %}
                </div>
                {% if is_acceptor %}
                    {% if solution.is_accepted %}
                        <button class="btn" type="submit" name="unaccept" value="1"></i>unaccept</button>
                    {% else %}
                        <button class="btn btn-success" type="submit" name="accept" value="1"></i>accept</button>
                    {% endif %}
                {% endif %}
            </form>
            {% if solution.is_completed %}
                <div class="alert alert-info">
                    <b>This solution was completed</b> on {{ solution.time_completed|date }}{% if not is_owner %}, please review it{% endif %}.
                </div>
            {% elif solution.is_accepted %}
                <div class="alert alert-success">
                    <b>This solution was accepted</b> on {{ solution.time_accepted|date }}.
                </div>
            {% endif %}
            {% if solution.task %}
                <div class="alert alert-info">
                    <strong>Parent task :</strong> <a href="{% url 'project:task:task' project.name solution.task.id %}">{{ solution.task.title }}</a> by {{ solution.task.owner.first_name }}
                </div>
            {% endif %}
            {% if solution.solution %}
                <div class="alert alert-info">
                    <strong>Parent solution :</strong> <a href="{% url 'project:solution:solution' project.name solution.solution.id %}">{{ solution.solution.default_title }}</a> by {{ solution.solution.user.first_name }}<br/>
                    <em>This is a suggested solution, meaning it did not stem from a task.</em>
                </div>
            {% endif %}
            {% if is_owner and not solution.is_accepted %}
                <div class="alert alert-danger">
                    <strong>Cannot open subtasks</strong> until the solution is accepted by parent task.
                </div>
            {% endif %}
            <span class="hidden-desktop hidden-tablet muted text-center">{{ solution.time_posted|timesince }} ago.</span>
            <hr/>
        </div>
        <div class="span2 muted text-right hidden-phone">
            {{ solution.time_posted|timesince }} ago.
        </div>
    </div>
    <div class="row">
        <div class="offset2 span8">
            <h5>Subtasks</h5>
        </div>
    </div>
    {% for task in subtasks %}
        <div class="row">
            {% with offset="offset2" %}
                {% include 'task/task_row_cells.html' %}
            {% endwith %}
        </div>
    {% empty %}
        <div class="row">
            <div class="offset2 span8">
                <p class="muted">No subtasks yet.</p>
            </div>
        </div>
    {% endfor %}
    <div class="row">
        <div class="offset2 span8">
            <h5>Suggested solutions</h5>
        </div>
    </div>
    <form method="post">
        {% csrf_token %}
        {% for suggested_solution in suggested_solutions %}
            <div class="row">
                {% with offset="offset2" solution=suggested_solution %}
                    {% include 'solution/solution_row_cells.html' %}
                {% endwith %}
            </div>
        {% empty %}
            <div class="row">
                <div class="offset2 span8">
                    <p class="muted">No suggested solutions yet.</p>
                </div>
            </div>
        {% endfor %}
    </form>
    <hr/>
    {% if is_owner %}
        <div class="alert alert-info">
            <p>Checkout solution branch :</p>
            <pre>git checkout -b s/{{ solution.id }} <i class="text-warning">[branch or sha to checkout]</i></pre>
            <p>Push to remote designated solution branch :</p>
            <pre>git push -u origin s/{{ solution.id }}</pre>
        </div>
    {% else %}
        <div class="alert alert-info">
            <p>Checkout solution branch :</p>
            <pre>git checkout -b s/{{ solution.id }} <i class="text-warning">[branch or sha to checkout]</i></pre>
            <p>Push to remote personal branch :</p>
            <pre>git push -u origin s/{{ solution.id }}:u/{{ user.username }}/s/{{ solution.id }}</pre>
        </div>
    {% endif %}
{% endblock %}